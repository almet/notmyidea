<!DOCTYPE html>
<html lang="en">
  <head>
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico" />

    <title>Service de nuages : Pourquoi avons-nous fait Cliquet ? - Alexis - Carnets en ligne</title>

    <meta charset="utf-8" />
    <link href="https://blog.notmyidea.org/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Alexis - Carnets en ligne Full Atom Feed" />
    <link rel="stylesheet" href="https://blog.notmyidea.org/theme/css/poole.css"/>
    <link rel="stylesheet" href="https://blog.notmyidea.org/theme/css/syntax.css"/>
    <link rel="stylesheet" href="https://blog.notmyidea.org/theme/css/lanyon.css"/>
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">
    <link rel="stylesheet" href="https://blog.notmyidea.org/theme/css/styles.css"/>



<style>

h1 {
    font-family: "Avant Garde", Avantgarde, "Century Gothic", CenturyGothic, "AppleGothic", sans-serif;
    padding: 80px 50px;
    text-align: center;
    text-transform: uppercase;
    text-rendering: optimizeLegibility;
    color: #202020;
    letter-spacing: .1em;
    text-shadow:
        -1px -1px 1px #111,
        2px 2px 1px #eaeaea;
}

#main {
    text-align: justify;
    text-justify: inter-word;
}
#main h1 {
    padding: 10px;
}

.post-headline {
    padding: 15px;
    text-align: center;
}
</style>
  </head>

  <body>
<!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">
<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <div class="profile">
      <img src="https://blog.notmyidea.org/theme/img/profile.png"/>
    </div>
  </div>

  <nav class="sidebar-nav">
  <a class="sidebar-nav-item" href="/">Articles</a>

  <a class="sidebar-nav-item" href="https://www.vieuxsinge.com">Brasserie du Vieux Singe</a>
  <a class="sidebar-nav-item" href="http://blog.notmyidea.org/pages/about.html">A propos</a>
  <a class="sidebar-nav-item" href="https://twitter.com/ametaireau">Messages courts</a>
  <a class="sidebar-nav-item" href="https://github.com/almet">Code</a>
  </nav>
</div>    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="https://blog.notmyidea.org/" title="Home">Alexis - Carnets en ligne</a>
          </h3>
        </div>
      </div>

      <div class="container content">
<div id="main" class="posts">
<h1 class="post-title">Service de nuages : Pourquoi avons-nous fait Cliquet ?</h1>

<span class="post-date">
    14 juillet 2015, dans <a class="no-color" href="category/technologie.html">Technologie</a>
</span>
<img id="illustration" class="illustration-Technologie" src="" />

<div class="post article">
    <h1>üåü</h1>
    <p><em>Cet article est repris depuis le blog ¬´ Service de Nuages ¬ª de mon √©quipe √† Mozilla</em></p>
<p><strong>tldr; Cliquet est un toolkit Python pour construire des APIs, qui impl√©mente
les bonnes pratiques en terme de mise en production et de protocole HTTP.</strong></p>
<div class="section" id="les-origines">
<h2>Les origines</h2>
<p>L'objectif pour le premier trimestre 2015 √©tait de construire un service de
stockage et de <a class="reference external" href="{filename}2015.04.service-de-nuages.rst">synchronisation de listes de lecture</a>.</p>
<p>Au d√©marrage du projet, nous avons tent√© de rassembler toutes les bonnes pratiques
et recommandations, venant de diff√©rentes √©quipes et surtout des derniers projets d√©ploy√©s.</p>
<p>De m√™me, nous voulions tirer parti du protocole de <em>Firefox Sync</em>, robuste et √©prouv√©,
pour la synchronisation des donn√©es ¬´offline¬ª.</p>
<p>Plut√¥t qu'√©crire un <a class="reference external" href="http://blog.octo.com/en/design-a-rest-api/">√©ni√®me</a>
<a class="reference external" href="http://www.vinaysahni.com/best-practices-for-a-pragmatic-restful-api">article</a> de blog,
nous avons pr√©f√©r√© les rassembler dans ce qu'on a appell√© ¬´un protocole¬ª.</p>
<p>Comme pour l'architecture envisag√©e nous avions deux projets √† construire, qui
devaient ob√©ir globalement √† ces m√™mes r√®gles, nous avons d√©cid√© de mettre en
commun l'impl√©mentation de ce protocole et de ces bonnes pratiques dans un
¬´toolkit¬ª.</p>
<p><em>Cliquet</em> est n√©.</p>
<img alt="Cliquet logo" class="align-center" src="{filename}/images/cliquet-logo.png" />
<div class="section" id="les-intentions">
<h3>Les intentions</h3>
<blockquote class="epigraph">
Quelle structure JSON pour mon API ? Quelle syntaxe pour filtrer la liste
via la querystring ? Comment g√©rer les √©critures concurrentes ?
Et synchroniser les donn√©es dans mon application cliente ?</blockquote>
<p>D√©sormais, quand un projet souhaite b√©n√©ficier d'une API REST pour stocker et consommer
des donn√©es, il est possible d'utiliser le <strong>protocole HTTP</strong> propos√©
et de se concentrer sur l'essentiel. Cela vaut aussi pour les clients, o√π
la majorit√© du code d'interaction avec le serveur est r√©utilisable.</p>
<blockquote class="epigraph">
Comment pouvons-nous v√©rifier que le service est op√©rationnel ? Quels indicateurs StatsD ?
Est-ce que Sentry est bien configur√© ? Comment d√©ployer une nouvelle version
sans casser les applications clientes ?</blockquote>
<p>Comme <em>Cliquet</em> fournit tout ce qui est n√©cessaire pour √™tre conforme avec les
exigences de la <strong>mise en production</strong>, le passage du prototype au service op√©rationnel
est tr√®s rapide ! De base le service r√©pondra aux attentes en terme supervision, configuration,
d√©ploiement et d√©pr√©ciation de version. Et si celles-ci √©voluent, il suffira
de faire √©voluer le toolkit.</p>
<blockquote class="epigraph">
Quel backend de stockage pour des documents JSON ? Comment faire si l'√©quipe
de production impose PostgreSQL ? Et si on voulait passer √† Redis ou en
m√©moire pour lancer les tests ?</blockquote>
<p>En terme d'impl√©mentation, nous avons choisi de <strong>fournir des abstractions</strong>.
En effet, nous avions deux services dont le coeur consistait
√† exposer un <em>CRUD</em> en <em>REST</em>, persistant des donn√©es JSON dans un backend.
Comme <em>Pyramid</em> et <em>Cornice</em> ne fournissent rien de tout pr√™t pour √ßa,
nous avons voulu introduire des classes de bases pour abstraire les notions
de resource REST et de backend de stockage.</p>
<p>Dans le but de tout rendre optionnel et ¬´pluggable¬ª, <strong>tout est configurable</strong>
depuis le fichier <tt class="docutils literal">.ini</tt> de l'application. Ainsi tous les projets qui utilisent
le toolkit se d√©ploieront de la m√™me mani√®re : seuls quelques √©l√©ments de configuration
les distingueront.</p>
<img alt="Une r√©union √† Paris..." class="align-center" src="{filename}/images/cliquet-notes-whiteboard.jpg" />
</div>
</div>
<div class="section" id="le-protocole">
<h2>Le protocole</h2>
<blockquote class="epigraph">
Est-ce suffisant de parler d'¬´API REST¬ª ? Est-ce bien n√©cessaire de
relire la spec HTTP √† chaque fois ? Pourquoi r√©inventer un protocole complet
√† chaque fois ?</blockquote>
<p>Quand nous d√©veloppons un (micro)service Web, nous d√©pensons g√©n√©ralement beaucoup
trop d'√©nergie √† (re)faire des choix (arbitraires).</p>
<p>Nul besoin de lister ici tout ce qui concerne la dimension
de la sp√©cification HTTP pure, qui nous impose le format des headers,
le support de CORS, la n√©gocation de contenus (types mime), la diff√©rence entre
authentification et autorisation, la coh√©rence des code status...</p>
<p>Les choix principaux du protocole concernent surtout :</p>
<ul class="simple">
<li><strong>Les resources REST</strong> : Les deux URLs d'une resource (pour la collection
et les enregistrements) acceptent des verbes et des headers pr√©cis.</li>
<li><strong>Les formats</strong> : le format et la structure JSON des r√©ponses est impos√©, ainsi
que la <a class="reference external" href="{filename}/2015.05.continuation-token.rst">pagination des listes</a>
ou la syntaxe pour filtrer/trier les resources via la <a class="reference external" href="https://en.wikipedia.org/wiki/Query_string">querystring</a>.</li>
<li><strong>Les timestamps</strong> : un num√©ro de r√©vision qui s'incr√©mente √† chaque op√©ration
d'√©criture sur une collection d'enregistrements.</li>
<li><strong>La synchronisation</strong> : une s√©rie de leviers pour r√©cup√©rer et renvoyer des
changements sur les donn√©es, sans perte ni collision, en utilisant les timestamps.</li>
<li><strong>Les permissions</strong> : les droits d'un utilisateur sur une collection ou un enregistrement
(<em>encore frais et sur le point d'√™tre document√©</em>) <a class="footnote-reference" href="#id3" id="id1">[1]</a>.</li>
<li><strong>Op√©rations par lot</strong>: une URL qui permet d'envoyer une s√©rie de requ√™tes
d√©crites en JSON et d'obtenir les r√©ponses respectives.</li>
</ul>
<p>Dans la dimension op√©rationnelle du protocole, on trouve :</p>
<ul class="simple">
<li><strong>La gestion de version</strong> : cohabitation de plusieurs versions en production,
avec alertes dans les ent√™tes pour la fin de vie des anciennes versions.</li>
<li><strong>Le report des requ√™tes</strong> : ent√™tes interpr√©t√©es par les clients, activ√©es en cas de
maintenance ou de surchage, pour m√©nager le serveur.</li>
<li><strong>Le canal d'erreurs</strong> : toutes les erreurs renvoy√©es par le serveur ont le m√™me
format JSON et ont un num√©ro pr√©cis.</li>
<li><strong>Les utilitaires</strong> : URLs diverses pour r√©pondre aux besoins exprim√©s par
l'√©quipe d'administrateurs (monitoring, metadonn√©es, param√®tres publiques).</li>
</ul>
<p>Ce protocole est une compilation des bonnes pratiques pour les APIs HTTP (<em>c'est notre m√©tier !</em>),
des conseils des administrateurs syst√®me dont c'est le m√©tier de mettre √† disposition des services
pour des millions d'utilisateurs et des retours d'exp√©rience de l'√©quipe
de <em>Firefox Sync</em> pour la gestion de la concurrence et de l'¬´offline-first¬ª.</p>
<p>Il est <a class="reference external" href="http://cliquet.readthedocs.org/en/latest/api/index.html">document√© en d√©tail</a>.</p>
<p>Dans un monde id√©al, ce protocole serait versionn√©, et formalis√© dans une RFC.
En r√™ve, il existerait m√™me plusieurs impl√©mentations avec des technologies diff√©rentes
(Python, Go, Node, etc.). <a class="footnote-reference" href="#id4" id="id2">[2]</a></p>
<table class="docutils footnote" frame="void" id="id3" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>Voir notre <a class="reference external" href="{filename}/2015.05.cliquet-permissions.rst">article d√©di√© sur les permissions</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id4" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td>Rappel: nous sommes une toute petite √©quipe !</td></tr>
</tbody>
</table>
</div>
<div class="section" id="le-toolkit">
<h2>Le toolkit</h2>
<div class="section" id="choix-techniques">
<h3>Choix techniques</h3>
<p><em>Cliquet</em> impl√©mente le protocole en Python (<em>2.7, 3.4+, pypy</em>), avec <a class="reference external" href="http://trypyramid.com/">Pyramid</a> <a class="footnote-reference" href="#id6" id="id5">[3]</a>.</p>
<p><strong>Pyramid</strong> est un framework Web qui va prendre en charge tout la partie HTTP,
et qui s'av√®re pertinent aussi bien pour des petits projets que des plus
ambitieux.</p>
<p><strong>Cornice</strong> est une extension de <em>Pyramid</em>, √©crite en partie par Alexis et Tarek,
qui permet d'√©viter d'√©crire tout le code <em>boilerplate</em> quand on construit une
API REST avec Pyramid.</p>
<p>Avec <em>Cornice</em>, on √©vite de r√©√©crire √† chaque fois le code qui va
cabler les verbes HTTP aux m√©thodes, valider les ent√™tes, choisir le s√©rialiseur
en fonction des ent√™tes de n√©gociation de contenus, renvoyer les codes HTTP
rigoureux, g√©rer les ent√™tes CORS, fournir la validation JSON √† partir de sch√©mas...</p>
<p><strong>Cliquet</strong> utilise les deux pr√©c√©dents pour impl√©menter le protocole et fournir
des abstractions, mais on a toujours <em>Pyramid</em> et <em>Cornice</em> sous la main pour
aller au del√† de ce qui est propos√© !</p>
<table class="docutils footnote" frame="void" id="id6" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id5">[3]</a></td><td>Au tout d√©but nous avons commenc√© une impl√©mentation avec <em>Python-Eve</em>
(Flask), mais n'√©tions pas satisfaits de l'approche pour la configuration
de l'API. En particulier du c√¥t√© magique.</td></tr>
</tbody>
</table>
</div>
<div class="section" id="concepts">
<h3>Concepts</h3>
<p>Bien √©videmment, les concepts du toolkit refl√®tent ceux du protocole mais il y
a des √©l√©ments suppl√©mentaires:</p>
<ul class="simple">
<li><strong>Les backends</strong> : abstractions pour le stockage, le cache et les permissions
(<em>ex. PostgreSQL, Redis, en-m√©moire, ...</em>)</li>
<li><strong>La supervision</strong> : logging JSON et indicateurs temps-r√©el (<em>StatsD</em>) pour suivre les
performances et la sant√© du service.</li>
<li><strong>La configuration</strong> : chargement de la configuration depuis les variables
d'environnement et le fichier <tt class="docutils literal">.ini</tt></li>
<li><strong>La flexibilit√©</strong> : d√©s/activation ou substitution de la majorit√© des composants
depuis la configuration.</li>
<li><strong>Le profiling</strong> : utilitaires de d√©veloppement pour trouver les <a class="reference external" href="https://fr.wiktionary.org/wiki/goulet_d%E2%80%99%C3%A9tranglement">goulets
d'√©tranglement</a>.</li>
</ul>
<img alt="Cliquet concepts" class="align-center" src="{filename}/images/cliquet-concepts.png" />
<p>Proportionnellement, l'impl√©mentation du protocole pour les resources REST est
la plus volumineuse dans le code source de <em>Cliquet</em>.
Cependant, comme nous l'avons d√©crit plus haut, <em>Cliquet</em> fournit tout un
ensemble d'outillage et de bonnes pratiques, et reste
donc tout √† fait pertinent pour n'importe quel type d'API, m√™me sans
manipulation de donn√©es !</p>
<p>L'objectif de la bo√Æte √† outils est de faire en sorte qu'un d√©veloppeur puisse constuire
une application simplement, en √©tant s√ªr qu'elle r√©ponde aux exigeances de la
mise en production, tout en ayant la possibilit√© de remplacer certaines parties
au fur et √† mesure que ses besoins se pr√©cisent.</p>
<p>Par exemple, la persistence fournie par d√©fault est <em>schemaless</em> (e.g <em>JSONB</em>),
mais rien n'emp√™cherait d'impl√©menter le stockage dans un mod√®le relationnel.</p>
<p>Comme les composants peuvent √™tre remplac√©s depuis la configuration, il est
tout √† fait possible d'√©tendre <em>Cliquet</em> avec des notions m√©tiers ou des
technologies exotiques ! Nous avons pos√© quelques id√©es dans <a class="reference external" href="http://cliquet.readthedocs.org/en/latest/ecosystem.html">la documentation
de l'√©co-syst√®me</a>.</p>
<p>Dans les prochaines semaines, nous allons introduire la notion d'¬´√©v√®nements¬ª (ou signaux),
qui permettraient aux extensions de s'interfacer beaucoup plus proprement.</p>
<p>Nous attachons beaucoup d'importance √† la claret√© du code, la pertinence des
<em>patterns</em>, des tests et de la documentation. Si vous avez des commentaires,
des critiques ou des interrogations, n'h√©sitez pas √† <a class="reference external" href="https://github.com/mozilla-services/cliquet/issues">nous en faire part</a> !</p>
</div>
</div>
<div class="section" id="cliquet-a-l-action">
<h2>Cliquet, √† l'action.</h2>
<p>Nous avons √©crit un <a class="reference external" href="http://cliquet.readthedocs.org/en/latest/quickstart.html">guide de d√©marrage</a>,
qui n'exige pas de conna√Ætre <em>Pyramid</em>.</p>
<p>Pour illustrer la simplicit√© et les concepts, voici quelques extraits !</p>
<div class="section" id="etape-1">
<h3>√âtape 1</h3>
<p>Activer <em>Cliquet</em>:</p>
<div class="highlight"><pre><span></span><span class="hll"><span class="kn">import</span> <span class="nn">cliquet</span>
</span><span class="kn">from</span> <span class="nn">pyramid.config</span> <span class="kn">import</span> <span class="n">Configurator</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">global_config</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">Configurator</span><span class="p">(</span><span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span>

<span class="hll">    <span class="n">cliquet</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;1.0&#39;</span><span class="p">)</span>
</span>    <span class="k">return</span> <span class="n">config</span><span class="o">.</span><span class="n">make_wsgi_app</span><span class="p">()</span>
</pre></div>
<p>√Ä partir de l√†, la plupart des outils de <em>Cliquet</em> sont activ√©s et accessibles.</p>
<p>Par exemple, les URLs <em>hello</em> (<tt class="docutils literal">/v1/</tt>) ou <em>supervision</em> (<tt class="docutils literal">/v1/__heartbeat__</tt>).
Mais aussi les backends de stockage, de cache, etc.
qu'il est possible d'utiliser dans des vues classiques <em>Pyramid</em> ou <em>Cornice</em>.</p>
</div>
<div class="section" id="etape-2">
<h3>√âtape 2</h3>
<p>Ajouter des vues:</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">global_config</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">):</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">Configurator</span><span class="p">(</span><span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span>

    <span class="n">cliquet</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;1.0&#39;</span><span class="p">)</span>
<span class="hll">    <span class="n">config</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="s2">&quot;myproject.views&quot;</span><span class="p">)</span>
</span>    <span class="k">return</span> <span class="n">config</span><span class="o">.</span><span class="n">make_wsgi_app</span><span class="p">()</span>
</pre></div>
<p>Pour d√©finir des resources CRUD, il faut commencer par d√©finir un sch√©ma,
avec <em>Colander</em>, et ensuite d√©clarer une resource:</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">cliquet</span> <span class="kn">import</span> <span class="n">resource</span><span class="p">,</span> <span class="n">schema</span>

<span class="k">class</span> <span class="nc">BookmarkSchema</span><span class="p">(</span><span class="n">schema</span><span class="o">.</span><span class="n">ResourceSchema</span><span class="p">):</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">URL</span><span class="p">()</span>

<span class="hll"><span class="nd">@resource.register</span><span class="p">()</span>
</span><span class="hll"><span class="k">class</span> <span class="nc">Bookmark</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">BaseResource</span><span class="p">):</span>
</span><span class="hll">    <span class="n">mapping</span> <span class="o">=</span> <span class="n">BookmarkSchema</span><span class="p">()</span>
</span></pre></div>
<p>D√©sormais, la resource CRUD est disponible sur <tt class="docutils literal">/v1/bookmarks</tt>, avec toutes
les fonctionnalit√©s de synchronisation, filtrage, tri, pagination, timestamp, etc.
De base les enregistrements sont priv√©s, par utilisateur.</p>
<div class="highlight"><pre><span></span><span class="err">$</span> <span class="err">http</span> <span class="err">GET</span> <span class="s2">&quot;http://localhost:8000/v1/bookmarks&quot;</span>
<span class="err">HTTP/</span><span class="mf">1.1</span> <span class="mi">200</span> <span class="err">OK</span>
<span class="err">...</span>
<span class="p">{</span>
    <span class="nt">&quot;data&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="nt">&quot;url&quot;</span><span class="p">:</span> <span class="s2">&quot;http://cliquet.readthedocs.org&quot;</span><span class="p">,</span>
            <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;cc103eb5-0c80-40ec-b6f5-dad12e7d975e&quot;</span><span class="p">,</span>
            <span class="nt">&quot;last_modified&quot;</span><span class="p">:</span> <span class="mi">1437034418940</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="section" id="etape-3">
<h3>√âtape 3</h3>
<p>√âvidemment, il est possible choisir les URLS, les verbes HTTP support√©s, de modifier
des champs avant l'enregistrement, etc.</p>
<div class="highlight"><pre><span></span><span class="hll"><span class="nd">@resource.register</span><span class="p">(</span><span class="n">collection_path</span><span class="o">=</span><span class="s1">&#39;/user/bookmarks&#39;</span><span class="p">,</span>
</span><span class="hll">                   <span class="n">record_path</span><span class="o">=</span><span class="s1">&#39;/user/bookmarks/{{id}}&#39;</span><span class="p">,</span>
</span><span class="hll">                   <span class="n">collection_methods</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,))</span>
</span><span class="k">class</span> <span class="nc">Bookmark</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">BaseResource</span><span class="p">):</span>
    <span class="n">mapping</span> <span class="o">=</span> <span class="n">BookmarkSchema</span><span class="p">()</span>

<span class="hll">    <span class="k">def</span> <span class="nf">process_record</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="n">old</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
</span><span class="hll">        <span class="k">if</span> <span class="n">old</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">new</span><span class="p">[</span><span class="s1">&#39;device&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">old</span><span class="p">[</span><span class="s1">&#39;device&#39;</span><span class="p">]:</span>
</span><span class="hll">            <span class="n">device</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;User-Agent&#39;</span><span class="p">)</span>
</span><span class="hll">            <span class="n">new</span><span class="p">[</span><span class="s1">&#39;device&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">device</span>
</span><span class="hll">        <span class="k">return</span> <span class="n">new</span>
</span></pre></div>
<p><a class="reference external" href="http://cliquet.readthedocs.org/en/latest/reference/resource.html">Plus d'infos dans la documentation d√©di√©e</a> !</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Il est possible de d√©finir des resources sans validation de schema.
<a class="reference external" href="https://github.com/mozilla-services/kinto/blob/master/kinto/views/records.py">Voir le code source de Kinto</a>.</p>
</div>
</div>
<div class="section" id="etape-4-optionelle">
<h3>√âtape 4 (optionelle)</h3>
<p>Utiliser les abstractions de <em>Cliquet</em> dans une vue <em>Cornice</em>.</p>
<p>Par exemple, une vue qui utilise le backend de stockage:</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">cliquet</span> <span class="kn">import</span> <span class="n">Service</span>

<span class="n">score</span> <span class="o">=</span> <span class="n">Service</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;score&quot;</span><span class="p">,</span>
                <span class="n">path</span><span class="o">=</span><span class="s1">&#39;/score/{game}&#39;</span><span class="p">,</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Store game score&quot;</span><span class="p">)</span>

<span class="nd">@score.post</span><span class="p">(</span><span class="n">schema</span><span class="o">=</span><span class="n">ScoreSchema</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">post_score</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">collection_id</span> <span class="o">=</span> <span class="s1">&#39;scores-&#39;</span> <span class="o">+</span> <span class="n">request</span><span class="o">.</span><span class="n">match_dict</span><span class="p">[</span><span class="s1">&#39;game&#39;</span><span class="p">]</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">authenticated_userid</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">validated</span>  <span class="c1"># c.f. Cornice.</span>

<span class="hll">    <span class="n">storage</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">storage</span>
</span><span class="hll">    <span class="n">record</span> <span class="o">=</span> <span class="n">storage</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">collection_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span>    <span class="k">return</span> <span class="n">record</span>
</pre></div>
</div>
</div>
<div class="section" id="vos-retours">
<h2>Vos retours</h2>
<p>N'h√©sitez pas √† nous faire part de vos retours ! Cela vous a donn√© envie
d'essayer ? Vous connaissez un outil similaire ?
Y-a-t-il des points qui ne sont pas clairs ? Manque de cas d'utilisation concrets ?
Certains aspects mal pens√©s ? Trop contraignants ? Trop de magie ? Overkill ?</p>
<p>Nous prenons tout.</p>
<div class="section" id="points-faibles">
<h3>Points faibles</h3>
<p>Nous sommes tr√®s fiers de ce que nous avons construit, en relativement peu
de temps. Et comme nous l'exposions dans <a class="reference external" href="{filename/2015.07.whistler-use-cases.rst}">l'article pr√©c√©dent</a>, il y a du potentiel !</p>
<p>Cependant, nous sommes conscients d'un certain nombre de points
qui peuvent √™tre vus comme des faiblesses.</p>
<ul class="simple">
<li><strong>La documentation d'API</strong> : actuellement, nous n'avons pas de solution pour qu'un
projet qui utilise <em>Cliquet</em> puisse int√©grer facilement toute
<a class="reference external" href="http://cliquet.readthedocs.org/en/latest/api/index.html">la documentation de l'API</a>
obtenue.</li>
<li><strong>La documentation</strong> : il est tr√®s difficile d'organiser la documentation, surtout
quand le public vis√© est aussi bien d√©butant qu'exp√©riment√©. Nous sommes probablement
victimes du ¬´<a class="reference external" href="https://en.wikipedia.org/wiki/Curse_of_knowledge">curse of knowledge</a>¬ª.</li>
<li><strong>Le protocole</strong> : on sent bien qu'on va devoir versionner le protocole. Au
moins pour le d√©solidariser des versions de <em>Cliquet</em>, si on veut aller au
bout de la philosophie et de l'√©co-syst√®me.</li>
<li><strong>Le conservatisme</strong> : Nous aimons la stabilit√© et la robustesse. Mais surtout
nous ne sommes pas tout seuls et devons nous plier aux contraintes de la mise
en production ! Cependant, nous avons tr√®s envie de faire de l'async avec Python 3 !</li>
<li><strong>Publication de versions</strong> : le revers de la m√©daille de la factorisation. Il
arrive qu'on pr√©f√®re faire √©voluer le toolkit (e.g. ajouter une option) pour
un point pr√©cis d'un projet. En cons√©quence, on doit souvent releaser les
projets en cascade.</li>
</ul>
</div>
<div class="section" id="quelques-questions-courantes">
<h3>Quelques questions courantes</h3>
<blockquote>
Pourquoi Python ?</blockquote>
<p>On prend beaucoup de plaisir √† √©crire du Python, et le calendrier annonc√©
initialement √©tait tr√®s serr√©: pas question de tituber avec une technologie
mal maitris√©e !</p>
<p>Et puis, apr√®s avoir pass√© pr√®s d'un an sur un projet Node.js, l'√©quipe avait
bien envie de refaire du Python.</p>
<blockquote>
Pourquoi pas Django ?</blockquote>
<p>On y a pens√©, surtout parce qu'il y a plusieurs fans de <em>Django REST Framework</em>
dans l'√©quipe.</p>
<p>On l'a √©cart√© principalement au profit de la l√©g√®ret√© et la modularit√© de
<em>Pyramid</em>.</p>
<blockquote>
Pourquoi pas avec un framework asynchrone en Python 3+ ?</blockquote>
<p>Pour l'instant nos administrateurs syst√®me nous imposent des d√©ploiements en
Python 2.7, √† notre grand d√©sarroi /o\</p>
<p>Pour <em>Reading List</em>, nous <a class="reference external" href="https://github.com/mozilla-services/readinglist/blob/1.7.0/readinglist/__init__.py#L19-L26">avions activ√©</a>
<em>gevent</em>.</p>
<p>Puisque l'approche consiste √† impl√©menter un protocole bien d√©termin√©, nous n'excluons
pas un jour d'√©crire un <em>Cliquet</em> en <em>aiohttp</em> ou <em>Go</em> si cela s'av√®rerait pertinent.</p>
<blockquote>
Pourquoi pas JSON-API ?</blockquote>
<p>Comme nous l'expliquions <a class="reference external" href="{filename}/2015.05.retour-apidays.rst">au retour des APIdays</a>,
JSON-API est une sp√©cification qui rejoint plusieurs de nos intentions.</p>
<p>Quand nous avons commenc√© le protocole, nous ne connaissions pas JSON-API.
Pour l'instant, comme notre proposition est beaucoup plus minimaliste, le
rapprochement n'a <a class="reference external" href="https://github.com/mozilla-services/cliquet/issues/254">pas d√©pass√© le stade de la discussion</a>.</p>
<blockquote>
Est-ce que Cliquet est un framework REST pour Pyramid ?</blockquote>
<p>Non.</p>
<p>Au del√† des classes de resources CRUD de Cliquet, qui impl√©mentent un
protocole bien pr√©cis, il faut utiliser Cornice ou Pyramid directement.</p>
<blockquote>
Est-ce que Cliquet est suffisamment g√©n√©rique pour des projets hors Mozilla ?</blockquote>
<p>Premi√®rement, nous faisons en sorte que tout soit contr√¥lable depuis la
configuration <tt class="docutils literal">.ini</tt> pour permettre la d√©s/activation ou substitution des
composants.</p>
<p>Si le protocole HTTP/JSON des resources CRUD vous satisfait,
alors Cliquet est probablement le plus court chemin pour construire une
application qui tient la route.</p>
<p>Mais l'utilisation des resources CRUD est facultative, donc Cliquet reste pertinent
si les bonnes pratiques en terme de mise en production ou les abstractions fournies
vous paraissent valables !</p>
<p>Cliquet reste un moyen simple d'aller tr√®s vite pour mettre sur pied
une application Pyramid/Cornice.</p>
<blockquote>
Est-ce que les resources JSON supporte les mod√®les relationnels complexes ?</blockquote>
<p>La couche de persistence fournie est tr√®s simple, et devrait
r√©pondre √† la majorit√© des cas d'utilisation o√π les donn√©es n'ont pas de
relations.</p>
<p>En revanche, il est tout √† fait possible de b√©n√©ficier de tous les aspects
du protocole en utilisant une classe <tt class="docutils literal">Collection</tt> maison, qui se chargerait
elle de manipuler les relations.</p>
<p>Le besoin de relations pourrait √™tre un bon pr√©texte pour impl√©menter le
protocole avec Django REST Framework :)</p>
<blockquote>
Est-il possible de faire ci ou √ßa avec Cliquet ?</blockquote>
<p>Nous aimerions collecter des besoins pour √©crire un ensemble de ¬´recettes/tutoriels¬ª. Mais
pour ne pas travailler dans le vide, nous aimerions <a class="reference external" href="https://github.com/mozilla-services/cliquet/issues">connaitre vos id√©es</a> !
(<em>ex. brancher l'authentification Github, changer le format du logging JSON, stocker des
donn√©es cartographiques, ...</em>)</p>
<blockquote>
Est-ce que Cliquet peut manipuler des fichiers ?</blockquote>
<p><a class="reference external" href="https://github.com/mozilla-services/cliquet/issues/236">Nous l'envisageons</a>,
mais pour l'instant nous attendons que le besoin survienne en interne pour se
lancer.</p>
<p>Si c'est le cas, le protocole utilis√© sera <a class="reference external" href="http://remotestorage.io/">Remote Storage</a>,
afin notamment de s'int√©grer dans l'√©co-syst√®me grandissant.</p>
<blockquote>
Est-ce que la fonctionnalit√© X va √™tre impl√©ment√©e ?</blockquote>
<p><em>Cliquet</em> est d√©j√† bien garni. Plut√¥t qu'impl√©menter la fonctionnalit√© X,
il y a de grandes chances que nous agissions pour s'assurer que les abstractions
et les m√©canismes d'extension fournis permettent de l'impl√©menter sous forme
d'extension.</p>
</div>
</div>

  </div>
</div>
      </div>

      <label for="sidebar-checkbox" class="sidebar-toggle"></label>

      <script>
        (function(document) {
          var i = 0;
          // snip empty header rows since markdown can't
          var rows = document.querySelectorAll('tr');
          for(i=0; i<rows.length; i++) {
            var ths = rows[i].querySelectorAll('th');
            var rowlen = rows[i].children.length;
            if (ths.length > 0 && ths.length === rowlen) {
              rows[i].remove();
            }
          }
        })(document);
      </script>

      <script>
        /* Lanyon & Poole are Copyright (c) 2014 Mark Otto. Adapted to Pelican 20141223 and extended a bit by @thomaswilley */
        (function(document) {
          var toggle = document.querySelector('.sidebar-toggle');
          var sidebar = document.querySelector('#sidebar');
          var checkbox = document.querySelector('#sidebar-checkbox');
          document.addEventListener('click', function(e) {
            var target = e.target;
            if(!checkbox.checked ||
            sidebar.contains(target) ||
            (target === checkbox || target === toggle)) return;
            checkbox.checked = false;
            }, false);
            })(document);
      </script>
      <!-- Piwik -->
      <script type="text/javascript">
        var _paq = _paq || [];
        _paq.push(['trackPageView']);
        _paq.push(['enableLinkTracking']);
        (function() {
          var u="//tracker.notmyidea.org/";
          _paq.push(['setTrackerUrl', u+'piwik.php']);
          _paq.push(['setSiteId', 3]);
          var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
          g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);
        })();
      </script>
      <noscript><p><img src="//tracker.notmyidea.org/piwik.php?idsite=3" style="border:0;" alt="" /></p></noscript>
      <!-- End Piwik Code -->
     </div>
  </body>
</html>