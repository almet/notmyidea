<!DOCTYPE html>
<html lang="en">
  <head>
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico" />

    <title>Let's Encrypt + HAProxy - Carnets en ligne</title>

    <meta charset="utf-8" />
    <link href="https://blog.notmyidea.org/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Carnets en ligne Full Atom Feed" />
    <link rel="stylesheet" href="https://blog.notmyidea.org/theme/css/poole.css"/>
    <link rel="stylesheet" href="https://blog.notmyidea.org/theme/css/syntax.css"/>
    <link rel="stylesheet" href="https://blog.notmyidea.org/theme/css/lanyon.css"/>
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">
    <link rel="stylesheet" href="https://blog.notmyidea.org/theme/css/styles.css"/>



<style>

h1 {
    font-family: "Avant Garde", Avantgarde, "Century Gothic", CenturyGothic, "AppleGothic", sans-serif;
    padding: 80px 50px;
    text-align: center;
    text-transform: uppercase;
    text-rendering: optimizeLegibility;
    color: #202020;
    letter-spacing: .1em;
    text-shadow:
        -1px -1px 1px #111,
        2px 2px 1px #eaeaea;
}

#main {
    text-align: justify;
    text-justify: inter-word;
}
#main h1 {
    padding: 10px;
}

.post-headline {
    padding: 15px;
    text-align: center;
}
</style>
  </head>

  <body>
<!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">
<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <div class="profile">
      <img src="https://blog.notmyidea.org/theme/img/profile.png"/>
    </div>
  </div>

  <nav class="sidebar-nav">
  <a class="sidebar-nav-item" href="/">Articles</a>

  </nav>
</div>    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="https://blog.notmyidea.org/" title="Home">Carnets en ligne</a>
          </h3>
        </div>
      </div>

      <div class="container content">
<div id="main" class="posts">
<h1 class="post-title">Let's Encrypt + HAProxy</h1>

<span class="post-date">
    11 f√©vrier 2016, dans <a class="no-color" href="category/technologie.html">Technologie</a>
</span>
<img id="illustration" class="illustration-Technologie" src="" />

<div class="post article">
    <h2 class="post-headline">Comment j'ai mis en place des certificats SSL avec Let's Encrypt derri√®re haproxy.</h2>
    <h1>üåü</h1>
    <p><em>Note : Cet article n'est plus √† jour. Il est maintenant (2018) possible d'installer des certificats SSL Let's Encrypt d'une mani√®re beaucoup plus simple, en utilisant certbot (et le plugin nginx <code>certbot --nginx</code>).</em></p>
<blockquote>
<p>It‚Äôs time for the Web to take a big step forward in terms of security
and privacy. We want to see HTTPS become the default. Let‚Äôs Encrypt
was built to enable that by making it as easy as possible to get and
manage certificates.</p>
<p>-- <a href="https://letsencrypt.org/">Let's Encrypt</a></p>
</blockquote>
<p>Depuis d√©but D√©cembre, la nouvelle <em>autorit√© de certification</em> Let's
Encrypt est pass√©e en version <em>Beta</em>. Les certificats SSL sont un moyen
de 1. chiffrer la communication entre votre navigateur et le serveur et
2. un moyen d'√™tre sur que le site Web auquel vous acc√©dez est celui
auquel vous pensez vous connecter (pour √©viter des <a href="https://fr.wikipedia.org/wiki/Attaque_de_l'homme_du_milieu">attaques de l'homme
du milieu</a>).</p>
<p>Jusqu'√† maintenant, il √©tait n√©cessaire de payer une entreprise pour
faire en sorte d'avoir des certificats qui √©vitent d'avoir ce genre
d'erreurs dans vos navigateurs:</p>
<p><img alt="Message de firefox lorsque une connexion n'est pas
s√©curis√©e." src="%7Bfilename%7D/static/unsecure-connection.png"></p>
<p>Maintenant, gr√¢ce √† Let's Encrypt il est possible d'avoir des
certificats SSL <strong>gratuits</strong>, ce qui repr√©sente un grand pas en avant
pour la s√©curit√© de nos communications.</p>
<p>Je viens de mettre en place un proc√©d√© (assez simple) qui permet de
configurer votre serveur pour g√©n√©rer des certificats SSL valides avec
Let's Encrypt et le r√©partiteur de charge
<a href="http://www.haproxy.org/">HAProxy</a>.</p>
<p>Je me suis bas√© pour cet article sur
d'<a href="https://blog.infomee.fr/p/letsencrypt-haproxy">autres</a>
<a href="http://blog.victor-hery.com/article22/utiliser-let-s-encrypt-avec-haproxy">articles</a>,
dont je vous recommande la lecture pour un compl√©ment d'information.</p>
<h2>Validation des domaines par Let's Encrypt</h2>
<p>Je vous passe les d√©tails d'installation du client de Let's Encrypt, qui
sont <a href="https://github.com/letsencrypt/letsencrypt#installation">tr√®s bien expliqu√©s sur leur
documentation</a>.</p>
<p>Une fois install√©, vous allez taper une commande qui va ressembler √†:</p>
<div class="highlight"><pre><span></span><span class="err">letsencrypt-auto certonly --renew-by-default</span>
<span class="err">--webroot -w /home/www/letsencrypt-requests/ \</span>
<span class="err">-d hurl.kinto-storage.org \</span>
<span class="err">-d forums.kinto-storage.org</span>
</pre></div>


<p>Le <em>webroot</em> est l'endroit ou les preuves de d√©tention du domaine vont
√™tre d√©pos√©es.</p>
<p>Lorsque les serveurs de Let's Encrypt vont vouloir v√©rifier que vous
√™tes bien √† l'origine des demandes de certificats, ils vont envoyer une
requ√™te HTTP sur <code>http://domaine.org/.well-known/acme-challenge</code>, ou il
voudra trouver des informations qu'il aura g√©n√©r√© via la commande
<code>letsencrypt-auto</code>.</p>
<p>J'ai choisi de faire une r√®gle dans haproxy pour diriger toutes les
requ√™tes avec le chemin <code>.well-known/acme-challenge</code> vers un <em>backend</em>
nginx qui sert des fichiers statiques (ceux contenus dans
<code>/home/www/letsencrypt-requests/</code>).</p>
<p>Voici la section de la configuration de HAProxy (et <a href="https://github.com/almet/infra/blob/master/haproxy/haproxy.cfg#L63-L72">la configuration
complete</a>
si √ßa peut √™tre utile):</p>
<div class="highlight"><pre><span></span><span class="n">frontend</span> <span class="n">http</span>
    <span class="n">bind</span> <span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">:</span><span class="mi">80</span>
    <span class="k">mode</span> <span class="n">http</span>
    <span class="n">default_backend</span> <span class="n">nginx_server</span>

    <span class="n">acl</span> <span class="n">letsencrypt_check</span> <span class="n">path_beg</span> <span class="o">/</span><span class="p">.</span><span class="n">well</span><span class="o">-</span><span class="n">known</span><span class="o">/</span><span class="n">acme</span><span class="o">-</span><span class="n">challenge</span>
    <span class="n">use_backend</span> <span class="n">letsencrypt_backend</span> <span class="k">if</span> <span class="n">letsencrypt_check</span>

    <span class="n">redirect</span> <span class="n">scheme</span> <span class="n">https</span> <span class="n">code</span> <span class="mi">301</span> <span class="k">if</span> <span class="o">!</span><span class="err">{</span> <span class="n">ssl_fc</span> <span class="err">}</span> <span class="o">!</span><span class="n">letsencrypt_check</span>

<span class="n">backend</span> <span class="n">letsencrypt_backend</span>
    <span class="n">http</span><span class="o">-</span><span class="n">request</span> <span class="k">set</span><span class="o">-</span><span class="n">header</span> <span class="k">Host</span> <span class="n">letsencrypt</span><span class="p">.</span><span class="n">requests</span>
    <span class="k">dispatch</span> <span class="mi">127</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">1</span><span class="p">:</span><span class="mi">8000</span>
</pre></div>


<p>Et celle de NGINX:</p>
<div class="highlight"><pre><span></span><span class="err">server {</span>
<span class="err">    listen 8000;</span>
<span class="err">    server_name letsencrypt.requests;</span>
<span class="err">    root /home/www/letsencrypt-requests;</span>
<span class="err">}</span>
</pre></div>


<h2>Installation des certificats dans HAProxy</h2>
<p>Vos certificats SSL devraient √™tre g√©n√©r√©s dans <code>/etc/letsencrypt/live</code>,
mais ils ne sont pas au format attendu par haproxy. Rien de grave, la
commande suivant convertit l'ensemble des certificats en une version
compatible avec
    HAProxy:</p>
<div class="highlight"><pre><span></span><span class="err">cat /etc/letsencrypt/live/domaine.org/privkey.pem /etc/letsencrypt/live/domaine.org/fullchain.pem &gt; /etc/ssl/letsencrypt/domaine.org.pem</span>
</pre></div>


<p>Et ensuite dans la configuration de haproxy, pour le (nouveau)
<em>frontend</em> https:</p>
<div class="highlight"><pre><span></span><span class="err">bind 0.0.0.0:443 ssl no-sslv3 crt /etc/ssl/letsencrypt</span>
</pre></div>


<p>Faites bien attention √† avoir un <em>frontend</em> https pour tous vos sites en
HTTPS. <a href="https://github.com/almet/infra/blob/master/haproxy/haproxy.cfg#L38-L60">Pour moi cela ressemble √†
√ßa</a>.</p>
<p>Une fois tout ceci fait, red√©marrez votre service haproxy et zou !</p>
<h2>Automatisation</h2>
<p>Pour automatiser un peu tout √ßa, j'ai choisi de faire √ßa comme suit:</p>
<ul>
<li>Un fichier domaine dans <code>letsencrypt/domains/domain.org</code> qui
    contient le script <code>letsencrypt</code>.</li>
<li>Un fichier d'installation de certificats dans
    <code>letsencrypt/install-certs.sh</code> qui s'occupe d'installer les
    certificats d√©j√† g√©n√©r√©s.</li>
</ul>
<p>Et voila ! <a href="https://github.com/almet/infra/">Le tout est dans un d√©pot
github</a>, si jamais √ßa peut vous servir,
tant mieux !</p>
  </div>
</div>
      </div>

      <label for="sidebar-checkbox" class="sidebar-toggle"></label>

      <script>
        (function(document) {
          var i = 0;
          // snip empty header rows since markdown can't
          var rows = document.querySelectorAll('tr');
          for(i=0; i<rows.length; i++) {
            var ths = rows[i].querySelectorAll('th');
            var rowlen = rows[i].children.length;
            if (ths.length > 0 && ths.length === rowlen) {
              rows[i].remove();
            }
          }
        })(document);
      </script>

      <script>
        /* Lanyon & Poole are Copyright (c) 2014 Mark Otto. Adapted to Pelican 20141223 and extended a bit by @thomaswilley */
        (function(document) {
          var toggle = document.querySelector('.sidebar-toggle');
          var sidebar = document.querySelector('#sidebar');
          var checkbox = document.querySelector('#sidebar-checkbox');
          document.addEventListener('click', function(e) {
            var target = e.target;
            if(!checkbox.checked ||
            sidebar.contains(target) ||
            (target === checkbox || target === toggle)) return;
            checkbox.checked = false;
            }, false);
            })(document);
      </script>
     </div>
  </body>
</html>